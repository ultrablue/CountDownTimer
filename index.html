<!DOCTYPE html>
<html lang="en" x-data="countdownApp()" x-init="loadTimers()">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Alpine.js Countdown</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Xanh+Mono:ital@0;1&display=swap" rel="stylesheet">



    <style>
        .xanh-mono-regular {
            font-family: "Xanh Mono", monospace;
            font-weight: 400;
            font-style: normal;
        }


        body {
            font-family: xanh-mono-regular, monospace;
            padding: 1rem;
        }

        .timer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            font-size: 10rem;
        }

        .timer .meta {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            align-items: flex-start;
        }

        .timer .meta .name {
            font-size: 1.2rem;
            font-weight: 600;
            line-height: 1;
        }

        .timer .meta .count {
            font-size: 4rem;
            line-height: 1;
        }

        .expired {
            background: #ed626e;
            color: #200b0d;
        }

        .expired-bg {
            background-color: #e66f79;
            transition: background-color 0.75s ease;
        }

        .almost-expired {
            background: #f9f1a5;
            color: #4a3c00;
        }

        button {
            margin-left: 0.5rem;
        }

        /* Settings modal */
        #settings-button {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        #settings-dialog {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
        }

        #settings-dialog .panel {
            background: white;
            color: inherit;
            padding: 1rem 1.25rem;
            border-radius: 6px;
            width: 320px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
        }

        #settings-dialog .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
        }

        /* Current time display (upper-left). Developers can override with #current-time or .current-time */
        #current-time,
        .current-time {
            /* position: fixed;*/
            top: 1rem;
            left: 1rem;
            font-size: 1.25rem;
            background: transparent;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
        }
    </style>
</head>

<body>

    <div id="current-time" class="current-time" aria-label="Current time" x-text="formatNow(now)"></div>

    <button id="settings-button" aria-label="Settings" @click="openSettings()">‚öôÔ∏è</button>

    <!-- Input Area -->
    <div class="input-area">
        <!-- <input type="time" x-model="newDt"> -->
        <input type="time" x-model="newTime" x-ref="timeInput" x-init="$refs.timeInput.focus()">
        <input type="text" x-model="newName" placeholder="Name (optional, max 50)" maxlength="50"
            style="margin-left:0.5rem;">
        <button @click="addTimer()">Add Timer</button>
    </div>

    <hr>

    <!-- Display Area -->
    <template x-for="timer in sortedTimers()" :key="timer.id">
        <div class="timer" :class="{
            'almost-expired': isAlmostExpired(timer, now),
            'expired-bg': isExpired(timer, now)
             }">
            <div class="meta">
                <div class="name" x-text="timer.name || 'Timer'"></div>
                <div class="count" x-text="formatCountdown(timer, now)"></div>
            </div>
            <button @click="removeTimer(timer)">
                <span x-text="isExpired(timer, now) ? 'Close' : 'Dismiss'"></span>
            </button>
        </div>
    </template>

    <!-- Settings dialog -->
    <div x-show="settingsOpen" x-cloak id="settings-dialog" role="dialog" aria-modal="true" aria-label="Settings"
        x-ref="settingsDialog">
        <div class="panel" @keydown.escape="cancelSettings()">
            <h3>Settings</h3>
            <div class="row">
                <label for="setting-time24">24-hour time</label>
                <input id="setting-time24" type="checkbox" x-model="tempSettings.time24">
            </div>
            <div class="row">
                <label for="setting-update-title">Update page title with soonest timer</label>
                <input id="setting-update-title" type="checkbox" x-model="tempSettings.updateTitle">
            </div>
            <div class="row">
                <label for="setting-default-display">Default display</label>
                <select id="setting-default-display" x-model="tempSettings.defaultDisplay">
                    <option value="compact_mmhh">Compact HH:MM</option>
                    <option value="precise_hhmmss">Precise HH:MM:SS</option>
                    <option value="block_minutes">Block minutes</option>
                </select>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:0.75rem;">
                <button @click="saveSettings()">Save</button>
                <button @click="cancelSettings()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        function countdownApp() {

            return {
                now: Date.now(),
                newDt: '',
                newTime: '',
                newName: '',
                timers: [],
                settings: {
                    time24: true,
                    updateTitle: false,
                    defaultDisplay: 'compact_mmhh'
                },
                tempSettings: {},
                settingsOpen: false,
                defaultTitle: 'CountDown Timer',
                // Display registry for pluggable display types
                displayRegistry: {},

                registerDisplay(spec) {
                    if (!spec || !spec.id) return;
                    this.displayRegistry[spec.id] = spec;
                },

                getDisplay(id) {
                    return this.displayRegistry[id] || this.displayRegistry[this.settings.defaultDisplay] || null;
                },

                loadTimers() {
                    const saved = localStorage.getItem('timers');
                    this.timers = saved ? JSON.parse(saved) : [];
                    this.loadSettings();
                    this.startTicker();
                },

                loadSettings() {
                    const raw = localStorage.getItem('countdownSettings');
                    if (raw) {
                        try {
                            this.settings = JSON.parse(raw);
                        } catch (e) {
                            console.warn('Failed to parse settings', e);
                        }
                    }
                    // ensure defaults for missing keys
                    this.settings.time24 = this.settings.time24 !== undefined ? this.settings.time24 : true;
                    this.settings.updateTitle = this.settings.updateTitle !== undefined ? this.settings.updateTitle : false;
                    this.settings.defaultDisplay = this.settings.defaultDisplay || 'compact_mmhh';
                },

                // Title handling
                titleFormatter(timer, now) {
                    // Prefer display-specific title formatter when available
                    const disp = this.getDisplay(timer.displayType || (this.settings && this.settings.defaultDisplay));
                    if (disp && typeof disp.title === 'function') return disp.title(timer, now);

                    // Fallback: time-only formatter (compact)
                    const diff = timer.until - now;
                    if (diff <= 0) return '00:00';
                    const totalSecs = Math.floor(diff / 1000);
                    const secs = totalSecs % 60;
                    const mins = Math.floor(totalSecs / 60) % 60;
                    const hrs = Math.floor(totalSecs / 3600);
                    const display = (this.settings && this.settings.defaultDisplay) || 'compact_mmhh';
                    if (display === 'precise_hhmmss') {
                        return [String(hrs).padStart(2, '0'), String(mins).padStart(2, '0'), String(secs).padStart(2, '0')].join(':');
                    }
                    if (display === 'block_minutes') {
                        const totalMins = Math.ceil(totalSecs / 60);
                        return totalMins + ' min';
                    }
                    // compact_mmhh fallback
                    return [String(hrs).padStart(2, '0'), String(mins).padStart(2, '0')].join(':');
                },

                updateTitle() {
                    try {
                        if (!this.settings || !this.settings.updateTitle) {
                            document.title = this.defaultTitle || 'Alpine.js Countdown';
                            return;
                        }
                        const sorted = this.sortedTimers();
                        if (!sorted.length) {
                            document.title = this.defaultTitle || 'Alpine.js Countdown';
                            return;
                        }
                        // Prefer the next non-expired timer so title moves on when one expires
                        const upcoming = sorted.find(t => t.until > this.now);
                        if (upcoming) {
                            const name = (upcoming.name && upcoming.name.trim()) || 'Timer';
                            document.title = name + ' - ' + this.titleFormatter(upcoming, this.now);
                            return;
                        }
                        // If no non-expired timers, fall back to default title
                        document.title = this.defaultTitle || 'Alpine.js Countdown';
                    } catch (e) {
                        console.warn('updateTitle failed', e);
                    }
                },

                openSettings() {
                    // copy settings for editing
                    this.tempSettings = JSON.parse(JSON.stringify(this.settings));
                    this.settingsOpen = true;
                    this.$nextTick(() => {
                        if (this.$refs.settingsDialog) this.$refs.settingsDialog.focus();
                    });
                },

                saveSettings() {
                    this.settings = JSON.parse(JSON.stringify(this.tempSettings));
                    localStorage.setItem('countdownSettings', JSON.stringify(this.settings));
                    this.settingsOpen = false;
                    this.applySettings();
                    this.updateTitle();
                },

                cancelSettings() {
                    this.settingsOpen = false;
                },

                applySettings() {
                    // If title updates are disabled, restore default title
                    if (!this.settings.updateTitle) document.title = 'Alpine.js Countdown';
                },

                saveTimers() {
                    localStorage.setItem('timers', JSON.stringify(this.timers));
                },

                addTimer() {
                    if (!this.newTime) return;
                    // Prepare name, trim and limit to 50 chars
                    let name = (this.newName || '').trim();
                    if (!name) name = 'Timer';
                    if (name.length > 50) name = name.slice(0, 50);
                    // This creates a new timer and pushes it onto the stack.
                    this.timers.push({
                        id: Date.now(),
                        until: this.createDateFromTimeString(this.newTime).getTime(),
                        name: name,
                        displayType: this.settings && this.settings.defaultDisplay
                    });
                    this.newTime = '';
                    this.newName = '';
                    this.saveTimers();
                    this.updateTitle();
                    this.$refs.timeInput.focus();
                },

                sortedTimers() {
                    return this.timers.slice().sort((a, b) => a.until - b.until);
                },

                isExpired(timer, now) {
                    // TODO: This should probably be a computed property on each timer. Or something.
                    return Date.now() >= timer.until;
                },

                isAlmostExpired(timer, now) {
                    //TODO: This should probably be a computed property on each timer. Or something.
                    const diff = timer.until - now;
                    return diff > 0 && diff < 5 * 60 * 1000; // 5 minutes 
                },

                formatCountdown(timer, now) {
                    // Dispatch to the display registry for rendering
                    const disp = this.getDisplay(timer.displayType || (this.settings && this.settings.defaultDisplay));
                    if (disp && typeof disp.render === 'function') return disp.render(timer, now);
                    // Fallback: compact mm:hh
                    const diff = timer.until - now;
                    if (diff <= 0) return '--:--';
                    const mins = Math.floor(diff / 1000 / 60 % 60);
                    const hrs = Math.floor(diff / 1000 / 3600 % 24);
                    return [String(hrs).padStart(2, '0'), String(mins).padStart(2, '0')].join(':') + " ‚è≥";
                },

                formatNow(now) {
                    const d = new Date(now || Date.now());
                    let hours = d.getHours();
                    const mins = d.getMinutes();
                    // Default to 24-hour unless settings.time24 === false
                    if (this.settings && this.settings.time24 === false) {
                        const ampm = hours >= 12 ? ' PM' : ' AM';
                        hours = hours % 12 || 12;
                        return String(hours) + ':' + String(mins).padStart(2, '0') + ampm;
                    }
                    return String(hours).padStart(2, '0') + ':' + String(mins).padStart(2, '0');
                },

                startTicker() {
                    setInterval(() => {
                        // Touch Alpine to re-render
                        this.now = Date.now();
                        // Update document.title if requested (centralized)
                        this.updateTitle();
                    }, 1000);
                },

                removeTimer(timer) {
                    if (!this.isExpired(timer) && !confirm('Dismiss this active timer?')) return;
                    this.timers = this.timers.filter(t => t.id !== timer.id);
                    this.saveTimers();
                    this.updateTitle();
                    this.$refs.timeInput.focus();
                },

                createDateFromTimeString(timeString) {
                    const [hours, minutes] = timeString.split(':').map(Number); // Split the string and convert to numbers
                    const now = new Date(); // Get the current date and time
                    now.setHours(hours); // Set the hours from the time string
                    now.setMinutes(minutes); // Set the minutes from the time string
                    now.setSeconds(0); // Set seconds to 0 (optional, but good practice)
                    now.setMilliseconds(0); // Set milliseconds to 0 (optional, but good practice)
                    return now;
                }
            }
        }
    </script>

    <script>
        // Register built-in displays after countdownApp is defined
        document.addEventListener('alpine:init', () => {
            // We expect countdownApp to register displays via its instance; however in this single-file app
            // we can also register directly by finding the Alpine component after init. Use a short delay.
            setTimeout(() => {
                try {
                    const root = document.querySelector('[x-data="countdownApp()"]');
                    if (!root) return;
                    const comp = root.__x.$data;
                    if (!comp || !comp.registerDisplay) return;

                    // compact_mmhh
                    comp.registerDisplay({
                        id: 'compact_mmhh',
                        meta: { precision: 'minutes', label: 'Compact HH:MM' },
                        render(timer, now) {
                            const diff = timer.until - now;
                            if (diff <= 0) return '00:00 ‚è≥';
                            const totalSecs = Math.floor(diff / 1000);
                            const mins = Math.floor(totalSecs / 60) % 60;
                            const hrs = Math.floor(totalSecs / 3600);
                            return [String(hrs).padStart(2, '0'), String(mins).padStart(2, '0')].join(':') + ' ‚è≥';
                        },
                        title(timer, now) {
                            const diff = timer.until - now;
                            if (diff <= 0) return '00:00';
                            const totalSecs = Math.floor(diff / 1000);
                            const mins = Math.floor(totalSecs / 60) % 60;
                            const hrs = Math.floor(totalSecs / 3600);
                            return [String(hrs).padStart(2, '0'), String(mins).padStart(2, '0')].join(':');
                        }
                    });

                    // precise_hhmmss
                    comp.registerDisplay({
                        id: 'precise_hhmmss',
                        meta: { precision: 'seconds', label: 'Precise HH:MM:SS' },
                        render(timer, now) {
                            const diff = timer.until - now;
                            if (diff <= 0) return '00:00:00';
                            const totalSecs = Math.floor(diff / 1000);
                            const secs = totalSecs % 60;
                            const mins = Math.floor(totalSecs / 60) % 60;
                            const hrs = Math.floor(totalSecs / 3600);
                            return [String(hrs).padStart(2, '0'), String(mins).padStart(2, '0'), String(secs).padStart(2, '0')].join(':');
                        },
                        title(timer, now) {
                            return this.render(timer, now);
                        }
                    });

                    // block_minutes
                    comp.registerDisplay({
                        id: 'block_minutes',
                        meta: { precision: 'minutes', label: 'Block Minutes' },
                        render(timer, now) {
                            const diff = timer.until - now;
                            if (diff <= 0) return '0 min';
                            const totalMins = Math.ceil(Math.max(0, diff) / 60000);
                            return totalMins + ' min';
                        },
                        title(timer, now) {
                            const diff = timer.until - now;
                            if (diff <= 0) return '0 min';
                            const totalMins = Math.ceil(Math.max(0, diff) / 60000);
                            return totalMins + ' min';
                        }
                    });
                } catch (e) {
                    console.warn('Failed to register displays', e);
                }
            }, 50);
        });
    </script>


    <div>
        Todo
        <ul>
            <li>Make the favicon update. üíö,üü¢; üíõ, üü°; ‚ù§Ô∏è,üî¥. How do we do that?
                https://css-tricks.com/emoji-as-a-favicon/</li>
            <li>One square (or other shape) per minute. Remove them one a time. Randomly or in a particular order. </li>
            <ul>
                <li>With non-decimal hour divisions. eg</li>
                <ul>
                    <li>1/3 hour (20 minutes)</li>
                    <li>1/4 hour (15 minutes)</li>
                    <li>1/6 hour (10 minutes)</li>
                    <li>1/12 hour (5 minutes)</li>
                </ul>
            </ul>
            <li>Update title with the timer that's due the sooner.</li>
            <li>Little blocks that indicate the total number of minutes, one block for minute. The current block shows
                the number of minutes remaining. Assume that it's in the upper left of the display. The other blocks
                change color. For example the final 5 blocks can be red or yellow. <br>
                Add some animations to note transitions. When the current number is up, make it fade or flyout and the
                other blocks move to fill the missing slot.</li>
        </ul>
    </div>


</body>

</html>