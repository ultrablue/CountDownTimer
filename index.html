<!DOCTYPE html>
<html lang="en" x-data="countdownApp()" x-init="loadTimers()">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Alpine.js Countdown</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Xanh+Mono:ital@0;1&display=swap" rel="stylesheet">



    <style>
        .xanh-mono-regular {
            font-family: "Xanh Mono", monospace;
            font-weight: 400;
            font-style: normal;
        }


        body {
            font-family: xanh-mono-regular, monospace;
            padding: 1rem;
        }

        .timer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            font-size: 10rem;
        }

        .expired {
            background: #ed626e;
            color: #200b0d;
        }

        .expired-bg {
            background-color: #e66f79;
            transition: background-color 0.75s ease;
        }

        .almost-expired {
            background: #f9f1a5;
            color: #4a3c00;
        }

        button {
            margin-left: 0.5rem;
        }
    </style>
</head>

<body>

    <!-- Input Area -->
    <div class="input-area">
        <!-- <input type="time" x-model="newDt"> -->
        <input type="time" x-model="newTime" x-ref="timeInput" x-init="$refs.timeInput.focus()">
        <button @click="addTimer()">Add Timer</button>
    </div>

    <hr>

    <!-- Display Area -->
    <template x-for="timer in sortedTimers()" :key="timer.id">
        <div class="timer" :class="{
            'almost-expired': isAlmostExpired(timer, now),
            'expired-bg': isExpired(timer, now)
             }">
            <div x-text="formatCountdown(timer, now)"></div>
            <button @click="removeTimer(timer)">
                <span x-text="isExpired(timer, now) ? 'Close' : 'Dismiss'"></span>
            </button>
        </div>
    </template>

    <script>
        function countdownApp() {

            return {
                now: Date.now(),
                newDt: '',
                newTime: '',
                timers: [],

                loadTimers() {
                    const saved = localStorage.getItem('timers');
                    this.timers = saved ? JSON.parse(saved) : [];
                    this.startTicker();
                },

                saveTimers() {
                    localStorage.setItem('timers', JSON.stringify(this.timers));
                },

                addTimer() {
                    if (!this.newTime) return;
                    // This creates a new timer and pushes it onto the stack.
                    this.timers.push({
                        id: Date.now(),
                        until: this.createDateFromTimeString(this.newTime).getTime()
                    });
                    this.newTime = '';
                    this.saveTimers();
                    this.$refs.timeInput.focus();
                },

                sortedTimers() {
                    return this.timers.slice().sort((a, b) => a.until - b.until);
                },

                isExpired(timer, now) {
                    // TODO: This should probably be a computed property on each timer. Or something.
                    return Date.now() >= timer.until;
                },

                isAlmostExpired(timer, now) {
                    //TODO: This should probably be a computed property on each timer. Or something.
                    const diff = timer.until - now;
                    return diff > 0 && diff < 5 * 60 * 1000; // 5 minutes 
                },

                formatCountdown(timer, now) {
                    // TODO This should be refactored to use specific formats like HH:MM:SS.
                    const diff = timer.until - now;
                    if (diff <= 0) return '--:--';
                    const mins = Math.floor(diff / 1000 / 60 % 60);
                    const hrs = Math.floor(diff / 1000 / 3600 % 24);
                    return [
                        //String(days).padStart(2, '0'),
                        String(hrs).padStart(2, '0'),
                        String(mins).padStart(2, '0'),
                        //String(secs).padStart(2, '0')
                    ].join(':') + " â³";
                },

                startTicker() {
                    setInterval(() => {
                        // Touch Alpine to re-render
                        this.now = Date.now();
                    }, 1000);
                },

                removeTimer(timer) {
                    if (!this.isExpired(timer) && !confirm('Dismiss this active timer?')) return;
                    this.timers = this.timers.filter(t => t.id !== timer.id);
                    this.saveTimers();
                    this.$refs.timeInput.focus();
                },

                createDateFromTimeString(timeString) {
                    const [hours, minutes] = timeString.split(':').map(Number); // Split the string and convert to numbers
                    const now = new Date(); // Get the current date and time
                    now.setHours(hours); // Set the hours from the time string
                    now.setMinutes(minutes); // Set the minutes from the time string
                    now.setSeconds(0); // Set seconds to 0 (optional, but good practice)
                    now.setMilliseconds(0); // Set milliseconds to 0 (optional, but good practice)
                    return now;
                }
            }
        }
    </script>


    <div>
        Todo
        <ul>
            <li>One square (or other shape) per minute. Remove them one a time. Randomly or in a particular order. </li>
            <ul>
                <li>With non-decimal hour divisions. eg</li>
                <ul>
                    <li>1/3 hour (20 minutes)</li>
                    <li>1/4 hour (15 minutes)</li>
                    <li>1/6 hour (10 minutes)</li>
                    <li>1/12 hour (5 minutes)</li>
                </ul>
            </ul>
            <li>Update title with the timer that's due the sooner.</li>
        </ul>
    </div>


</body>

</html>